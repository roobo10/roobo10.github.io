<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css" integrity="sha384-oS3vJWv+0UjzBfQzYUhtDYW+Pj2yciDJxpsK1OYPAYjqT085Qq/1cq5FLXAZQ7Ay" crossorigin="anonymous">

    <title>Breast Cancer Proforma</title>
    <style>
    #reportText {
      font-family: "Times New Roman"; font-size: 11pt;
    }
    .report-title {
      font-size: 11pt;
      font-weight: bold;
      text-decoration: underline;
      text-transform: uppercase;
    }
    .report-heading {
      font-weight: bold;
      text-decoration: underline;
    }
    </style>
  </head>
  <body onload="addTumour(); addMargin(); addMargin(); addMargin(); addMargin(); addCavityShaving(); addReceptors(); updateReport();">
    <div class="container">
      <h1>Breast Cancer Proforma</h1>
        <p class="lead">version 1.0 beta</p>
        <p class="mb-5">If you notice something that doesn't work as you think it should, please log it either <a href="https://scottish.sharepoint.com/sites/PathologyTeam2-Consultants/_layouts/15/listform.aspx?PageType=8&ListId=%7B1F350A38-B19D-4DED-A3E0-433ABBDB5A0B%7D&RootFolder=%2Fsites%2FPathologyTeam2-Consultants%2FLists%2FBug%20Tracker&Source=https%3A%2F%2Fscottish.sharepoint.com%2Fsites%2FPathologyTeam2-Consultants%2FLists%2FBug%2520Tracker%2FAllItems.aspx&ContentTypeId=0x01030016557293936E7D449F135AE61B810678">Microsoft Teams</a> or on <a href="https://github.com/roobo10/roobo10.github.io/issues/new">Github</a>.
    <div id="report-fields" class="my-2">
      <div id="toolbar" class="float-right">
        <button class="btn btn-primary" onclick="addTumour()"><i class="fas fa-plus-square"></i>&nbsp;&nbsp;Add Tumour</button>
      </div>
      <div id="tumours" class="my-2">
      </div>
      <div class="form-group row">
        <label class="col-sm-4 col-form-label"></label>
        <div class="col-sm-8 text-center">
          <button class="btn btn-outline-primary col-sm-10" onclick="addTumour()"><i class="fas fa-plus-square"></i>&nbsp;&nbsp;Add Tumour</button>
        </div>
      </div>      
      <h2>Background Breast</h2>
      <div class="form-group row">
        <label for="r-backgroud-breast" class="col-sm-4 col-form-label">Description of background abnormalities including LCIS etc.</label>
        <div class="col-sm-8">
          <div class="col-sm-12 row">
            <textarea id="r-background-breast" class="form-control" rows="3"></textarea>
          </div>
        </div>
      </div>
      <button class="btn btn-sm btn-primary mx-2 float-right" onclick="addMargin()"><i class="fas fa-plus-square"></i>&nbsp;&nbsp;Add Margin</button>
      <button class="btn btn-sm btn-primary mx-2 float-right" onclick="addCavityShaving()"><i class="fas fa-plus-square"></i>&nbsp;&nbsp;Add Cavity Shaving</button>
      <h2>Margins</h2>
      <div class="form-group row">
        <label class="col-sm-3 col-form-label" id="nearest-margin-label">Nearest Margin</label>
        <div class="col-sm-9">
          <div class="form-group row">
            <div class="col-sm-12" id="margins">

            </div>
          </div>
        </div>
      </div>
      <div class="form-group row">
        <label class="col-sm-3 col-form-label" id="cavity-shavings-label">Cavity Shavings</label>
        <div class="col-sm-9">
          <div class="form-group row">
            <div class="col-sm-12" id="shavings">

            </div>
          </div>
        </div>
      </div>

      <h2>Lymph Nodes</h2>
      <div class="form-group row">
        <label for="r-node-biopsy-type" class="col-sm-4 col-form-label">Biopsy Type</label>
        <div class="col-sm-8">
          <select class="form-control" id="r-node-biopsy-type">
            <option value="snb">Sentinel Node Biopsy</option>
            <option value="clearance">Axillary Clearance</option>
            <option value="none">None</option>
            <option value="other" selected="selected">Other</option>
          </select>
        </div>
      </div>
      <div id="lymph-nodes-section">
        <div class="form-group row">
          <label for="r-total-nodes" class="col-sm-4 col-form-label">Total Lymph Nodes</label>
          <div class="col-sm-8">
            <div class="col-sm-12 row">
              <input type="text" class="form-control col-sm-1" id="r-total-nodes">
            </div>
          </div>
        </div>
        <div class="form-group row">
          <label for="r-macrometastases" class="col-sm-4 col-form-label">Nodes with macrometastases</label>
          <div class="col-sm-8">
            <div class="col-sm-12 row">
              <input type="text" class="form-control col-sm-1" id="r-macrometastases"><div class="col-sm-8 mx-2">Metastases &gt;2mm</div>
            </div>
          </div>
        </div>
        <div class="form-group row">
          <label for="r-micrometastases" class="col-sm-4 col-form-label">Nodes with micrometastases</label>
          <div class="col-sm-8">
            <div class="col-sm-12 row">
              <input type="text" class="form-control col-sm-1" id="r-micrometastases"><div class="col-sm-8 mx-2">Metastases &gt;0.2mm and &le;2mm</div>
            </div>
          </div>
        </div>
        <div class="form-group row">
          <label for="r-its" class="col-sm-4 col-form-label">Nodes with individual tumour cells</label>
          <div class="col-sm-8">
            <div class="col-sm-12 row">
              <input type="text" class="form-control col-sm-1" id="r-itc"><div class="col-sm-8 mx-2">Metastases &le;0.2mm</div>
            </div>
          </div>
        </div>
      </div>
      <h2>Neoadjuvant Therapy Response</h2>
      <div class="form-group row">
        <label for="r-neoadjuvant-given" class="col-sm-4 col-form-label">Neoadjuvant therapy given</label>
        <div class="col-sm-8">
          <select class="form-control" id="r-neoadjuvant-given">
            <option value="no"> No</option>
            <option value="yes">Yes</option>
          </select>
        </div>
      </div>
      <div class="form-group row">
        <label for="r-neoadjuvant-breast-response" class="col-sm-4 col-form-label">Breast disease response</label>
        <div class="col-sm-8">
          <select class="form-control" id="r-neoadjuvant-breast-response">
            <option value="1">Complete pathological response</option>
            <option value="2">Partial response to therapy</option>
            <option value="2A">Minimal residual disease/near total effect typically (&lt;10% of tumour remaining)</option>
            <option value="2B">Evidence of response but significant tumour remaining (&gt;10% of tumour remaining)</option>
            <option value="3">No evidence of response to therapy</option>
          </select>
        </div>
      </div>
      <div class="form-group row">
        <label for="r-neoadjuvant-node-response" class="col-sm-4 col-form-label">Lymph node disease response</label>
        <div class="col-sm-8">
          <select class="form-control" id="r-neoadjuvant-node-response">
            <option value="1">No evidence of metastatic disease and no evidence of changes in the lymph nodes</option>
            <option value="2">Metastatic tumour not detected but evidence of response</option>
            <option value="3">Metastatic disease present but also evidence of response</option>
            <option value="4">Metastatic disease present with no evidence of response to therapy</option>
          </select>
        </div>
      </div>
      <h2>Comments</h2>
      <div class="form-group row">
        <label for="r-comments" class="col-sm-4 col-form-label">Other comments</label>
        <div class="col-sm-8">
          <div class="col-sm-12 row">
            <textarea id="r-comments" class="form-control" rows="3"></textarea>
          </div>
        </div>
      </div>
      <button class="btn btn-sm btn-primary mx-2 float-right" onclick="addReceptors()"><i class="fas fa-plus-square"></i>&nbsp;&nbsp;Add Receptor Set</button>
      <h2>Receptors</h2>
      <div id="receptors">

      </div>
      <h2>Genetics</h2>
      <div class="form-group row">
        <label class="col-sm-4 col-form-label">Best Tumour Block</label>
        <div class="col-sm-8">
          <div class="row col-sm-12">
            <div class="col-sm-6 form-inline">
              <label for="dsGeneticsTumour1" class="col-sm-7 col-form-label">Tumour Block</label>
              <input type="text" class="form-control col-sm-3" id="dsGeneticsBestTumour1">
            </div>
            <div class="col-sm-6 form-inline">
              <label for="dsGeneticsTumourPercentage1" class="col-sm-7 col-form-label">Percentage Tumour</label>
              <input type="text" class="form-control col-sm-3" id="dsGeneticsTumourPercentage1"><div class="col-sm-1">%</div>
            </div>
          </div>
        </div>
      </div>
      <div class="form-group row">
        <label for="dsGeneticsNormal" class="col-sm-4 col-form-label">Best Normal Control</label>
        <div class="col-sm-8">
          <div class="col-sm-12 row">
            <input type="text" class="form-control col-sm-2" id="dsGeneticsNormal">
          </div>
        </div>
      </div>
      <div id="reportText" class="">
      </div>
      <div class="row my-2">
        <div class="col-sm-12">
          <button onclick="copyToClipboard()" class="btn btn-lg btn-primary float-right mt-4 mb-4"><i class="fas fa-file-word"></i>&nbsp;&nbsp;Copy To Clipboard</button>
        </div>
      </div>
    </div>
    <div id="tumour-template" class="d-none">
      <div class="tumour-close-button float-right">
        <button onclick="removeTumour(this)" class="btn btn-outline-danger"><i class="fas fa-times"></i></button>
      </div>
      <h2 class="tumour-heading">Tumour</h2>
      <div class="form-group row">
        <label for="r-tumour-description" class="col-sm-4 col-form-label">Tumour Label (leave blank if none)</label>
        <div class="col-sm-8">
          <input type="text" class="form-control col-sm-12" id="r-tumour-description" />
        </div>
      </div>
      <div class="form-group row">
        <label class="col-sm-4 col-form-label" data-report-text="Tumour type">Tumour Type</label>
        <div class="col-sm-8">
          <div class="row tumour-types-list">
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" value="ductal" id="r-idc-tumour" checked>
              <label class="form-check-label" for="r-idc-tumour" data-report-text="Invasive Ductal Carcinoma">Invasive Ductal Carcinoma</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" value="lobular" id="r-ilc-tumour">
              <label class="form-check-label" for="r-ilc-tumour" data-report-text="Invasive Lobular Carcinoma">Invasive Lobular Carcinoma</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" value="tubular" id="r-tubular-tumour">
              <label class="form-check-label" for="r-tubular-tumour" data-report-text="Tubular Carcinoma">Tubular/cribriform</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" value="mucinous" id="r-mucinous-tumour">
              <label class="form-check-label" for="r-mucinous-tumour" data-report-text="Mucinous Carcinoma">Mucinous</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" value="medullary" id="r-medullary-tumour">
              <label class="form-check-label" for="r-medullary-tumour" data-report-text="Meullary-like Carcinoma">Medullary-like</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" value="micropapillary" id="r-micropapillary-tumour">
              <label class="form-check-label" for="r-micropapillary-tumour" data-report-text="Micropapillary Carcinoma">Micropapillary</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" value="other"  id="r-other-tumour">
              <label class="form-check-label" for="r-other-tumour" data-report-text="Other">Other</label>
            </div>
            <div class="container-other-tumour-text form-group">
              <input type="text" class="form-control col-sm-12" id="r-other-tumour-text">
            </div>
          </div>
        </div>
      </div>
      <div class="form-group row">
        <label class="col-sm-4 col-form-label" data-report-text="Tumour grade">Tumour Grade</label>
        <div class="col-sm-8">
          <div class="row">
            <div class="col-sm-12 form-inline my-1">
              <label class="col-form-label col-4 justify-content-end" data-report-text="T" for="r-tg-tubules">Tubules</label>
              <select class="form-control col-8" id="tg-tubules">
                <option value="1">1 (&gt;75%)</option>
                <option value="2">2 (10-75%)</option>
                <option value="3">3 (&lt;10%)</option>
              </select>
            </div>
            <div class="col-sm-12 form-inline my-1">
              <label class="col-form-label col-4 justify-content-end" data-report-text="P" for="r-tg-pleomorphism">Nuclear Pleomorphism</label>
              <select class="form-control col-8" id="tg-pleomorphism">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
              </select>
            </div>
            <div class="col-sm-12 form-inline my-1">
              <label class="col-form-label col-4 justify-content-end" data-report-text="M" for="r-tg-mitoses">Mitoses</label>
              <select class="form-control col-8" id="tg-mitoses">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
              </select>
            </div>
          </div>
        </div>
      </div>
      <div class="form-group row">
        <label for="r-lvi" class="col-sm-4 col-form-label">Lymphovascular Invasion</label>
        <div class="col-sm-8">
          <select class="form-control" id="r-lvi">
            <option value="false">Absent</option>
            <option value="true">Present</option>
          </select>
        </div>
      </div>
      <div class="form-group row">
        <label for="r-dcis" class="col-sm-4 col-form-label">Ductal Carcinoma In-Situ</label>
        <div class="col-sm-8">
          <select class="form-control" id="r-dcis">
            <option>Not Present</option>
            <option>High-Grade</option>
            <option>Intermediate-Grade</option>
            <option>Low-Grade</option>
          </select>
        </div>
      </div>
      <div class="form-group row">
        <label for="r-plcis" class="col-sm-4 col-form-label">Pleomohic Lobular Carcinoma In-Situ</label>
        <div class="col-sm-8">
          <select class="form-control" id="r-plcis">
            <option value="0">Not Present</option>
            <option value="1">Present</option>
          </select>
        </div>
      </div>
      <div class="form-group row">
        <label for="r-its" class="col-sm-4 col-form-label">Invasive Tumour Size</label>
        <div class="col-sm-8">
          <div class="col-sm-12 row">
            <input type="text" class="form-control col-sm-1" id="r-its"><div class="col-sm-1">mm</div>
          </div>
        </div>
      </div>
      <div class="form-group row">
        <label for="r-wts" class="col-sm-4 col-form-label">Whole Tumour Size</label>
        <div class="col-sm-8">
          <div class="col-sm-12 row">
            <input type="text" class="form-control col-sm-1" id="r-wts"><div class="col-sm-1">mm</div>
          </div>
        </div>
      </div>
    </div>

    <div class="row my-1 d-none" id="margin-template">
      <select class="col-sm-2 form-control mr-2" id="r-margin-location">
        <option value="superior">Superior</option>
        <option value="lateral">Lateral</option>
        <option value="inferior">Inferior</option>
        <option value="medial">Medial</option>
        <option value="anterior">Anterior</option>
        <option value="posterior">Posterior</option>
        <option value="superolateral">Superolateral</option>
        <option value="superomedial">Superomedial</option>
        <option value="inferolateral">Inferolateral</option>
        <option value="inferomedial">Inferomedial</option>
        <option value="unassessable">Unassessable</option>
      </select>
      <select class="col-sm-2 form-control" onchange="changedMargin(this)" id="r-margin-involved">
        <option value="uninvolved" data-report-text="Clear">Clear</option>
        <option value="involved" data-report-text="Involved by carcinoma">Involved (Carcinoma)</option>
        <option value="involved" data-report-text="Involved by DCIS">Involved (DCIS)</option>
        <option value="involved" data-report-text="Involved by Pleomohic LCIS">Involved (PLCIS)</option>
        <option value="involved" data-report-text="Involved by carcinoma and DCIS">Involved (Carcinoma &amp; DCIS)</option>
        <option value="involved" data-report-text="Involved by carcinoma and Pleomohic LCIS">Involved (Carcinoma &amp; PLCIS)</option>
        <option value="involved" data-report-text="Involved">Involved</option>
      </select>
      <input type="text" class="form-control col-sm-1 ml-1 mr-0" id="r-margin-distance">
      <div class="col-sm-3 pl-1" id="r-margin-distance-label">mm from margin</div> <button class="btn btn-sm btn-outline-danger my-1 ml-2 margin-remove-button" onclick="removeMargin(this)"><i class="fas fa-times"></i>&nbsp;&nbsp;Remove</button>
    </div>
    <div class="row my-1 d-none" id="shavings-template">
      <select class="col-sm-2 form-control mr-2" id="r-cs-location">
        <option value="superior">Superior</option>
        <option value="lateral">Lateral</option>
        <option value="inferior">Inferior</option>
        <option value="medial">Medial</option>
        <option value="anterior">Anterior</option>
        <option value="posterior">Posterior</option>
        <option value="superolateral">Superolateral</option>
        <option value="superomedial">Superomedial</option>
        <option value="inferolateral">Inferolateral</option>
        <option value="inferomedial">Inferomedial</option>
        <option value="unassessable">Unassessable</option>
      </select>
      <select class="col-sm-4 form-control" onchange="changedShaving(this)" id="r-cs-involved">
        <option value="uninvolved" data-report-text="Clear">Clear</option>
        <option value="involved" data-report-text="Involved by carcinoma">Involved (Carcinoma)</option>
        <option value="involved" data-report-text="Involved by DCIS">Involved (DCIS)</option>
        <option value="involved" data-report-text="Involved by Pleomorphic LCIS">Involved (Pleomohic LCIS)</option>
        <option value="involved" data-report-text="Involved by carcinoma and DCIS">Involved (Carcinoma &amp; DCIS)</option>
        <option value="involved" data-report-text="Involved by carcinoma and pleomohic LCIS">Involved (Carcinoma &amp; Pleomohic LCIS)</option>
        <option value="involved" data-report-text="Involved">Involved</option>
        <option value="involved_margin" data-report-text="Margin involved by carcinoma">Margin involved (Carcinoma)</option>
        <option value="involved_margin" data-report-text="Margin involved by DCIS">Margin involved (DCIS)</option>
        <option value="involved_margin" data-report-text="Margin involved by Pleomorphic LCIS">Margin involved (Pleomohic LCIS)</option>
        <option value="involved_margin" data-report-text="Margin involved by carcinoma and DCIS">Margin involved (Carcinoma &amp; DCIS)</option>
        <option value="involved_margin" data-report-text="Margin involved by carcinoma and pleomohic LCIS">Margin involved (Carcinoma &amp; Pleomohic LCIS)</option>
      </select>
      <input type="text" class="form-control col-sm-1 ml-1 mr-0 d-none" id="r-cs-distance">
      <div class="col-sm-2 p-0 ml-1 d-none" id="r-cs-distance-label">mm from margin</div><div class=""><button class="btn btn-sm btn-outline-danger my-1 ml-2 cs-remove-button" onclick="removeShaving(this)"><i class="fas fa-times"></i>&nbsp;Remove</button></div>
    </div>

    <div class="row my-1 d-none" id="receptors-template">
      <label class="col-sm-4 col-form-label">Hormone Receptor Set<button class="btn btn-outline-danger btn-sm m-2" onclick="removeReceptors(this)"><i class="fas fa-times"></i>&nbsp;&nbsp;Remove</button></label>
      <div class="col-sm-8">
        <div class="row form-group">
          <label for="r-receptors-desc" class="col-sm-5 col-form-label">Desciption (leave blank if none):</label><input type="text" class="form-control col-sm-7" id="r-receptors-desc">
        </div>
        <div class="row form-group">
          <label for="r-receptors-labno" class="col-sm-5 col-form-label">Report Number:</label><input type="text" class="form-control col-sm-7" id="r-receptors-labno">
        </div>
        <div class="row form-group">
          <label class="col-sm-2 col-form-label">ER:</label>
          <label for="r-er-p" class="col-sm-2 col-form-label">Proportion</label><input type="text" class="form-control col-sm-1" id="r-er-p">
          <label for="r-er-i" class="col-sm-2 col-form-label ml-4">Intensity</label><input type="text" class="form-control col-sm-1" id="r-er-i">
        </div>
        <div class="row form-group">
          <label class="col-sm-2 col-form-label">PR:</label>
          <label for="r-pr-p" class="col-sm-2 col-form-label">Proportion</label><input type="text" class="form-control col-sm-1" id="r-pr-p">
          <label for="r-pr-i" class="col-sm-2 col-form-label ml-4">Intensity</label><input type="text" class="form-control col-sm-1" id="r-pr-i">
        </div>
        <div class="form-group row">
          <label for="r-her2" class="col-sm-2 col-form-label">Her-2</label>
          <select class="form-control col-sm-7" id="r-her2">
            <option>Negative</option>
            <option>Positive</option>
            <option>Not Done</option>
          </select>
        </div>
      </div>
    </div>
  </div>
    <script src="../lib/js/utils.js" type="text/javascript"></script>
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.2/jquery.validate.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.2/additional-methods.min.js"></script>
    <script>
      var urlParams = getParameters();

      var debug = false;

      if("debug" in urlParams)
      {
        debug = urlParams["debug"] == "true" ? true : false;
      }

      if (debug) {
        $("#reportText").removeClass("d-none");
      }
      else {
        $("#reportText").addClass("d-none");
      }

      $(function () {
        $('[data-toggle="tooltip"]').tooltip()
      })

      var tumourCount = 1;
      var tumourId = 0;
      var marginId = 0;
      var shavingId = 0;
      var receptorId = 0;

      function addTumour() {
        var el = $("#tumour-template").clone().removeClass("d-none").addClass("tumour-section").attr('id','tumour-'+tumourId).appendTo("#tumours");
        var els = el.find("input[id]").each (function(i) {
          $(this).attr('id',$(this).attr('id') + "-" + tumourId);
        })

        var els = el.find("label[for]").each (function(i) {
          $(this).attr('for',$(this).attr('for') + "-" + tumourId);
        })

        var els = el.find("select[id]").each (function(i) {
          $(this).attr('id',$(this).attr('id') + "-" + tumourId);
        })
        tumourCount++;
        tumourId++;
        attachEvents();
        updateTumourCount();
      }

      function removeTumour(el) {
        el.closest('div.tumour-section').remove();
        tumourCount--;
        updateTumourCount();
      }

      function addMargin() {

        var marginsPresent = []
        $("#margins").find("select[id^=r-margin-location]").find(":selected").each(function(i) {
          marginsPresent.push($(this).val())
        });

        var el = $("#margin-template").clone().removeClass("d-none").addClass("margin-section").attr('id','margin-'+marginId).appendTo("#margins");

        var els = el.find("input[id]").each (function(i) {
          $(this).attr('id',$(this).attr('id') + "-" + marginId);
        })

        var els = el.find("select[id]").each (function(i) {
          $(this).attr('id',$(this).attr('id') + "-" + marginId);
        })

        el.find("select[id^=r-margin-location]").find("option").each(function(i){
          if (!marginsPresent.includes($(this).val())) {
            $(this).prop("selected",true)
            return false;
          }
        })
        attachEvents();

        updateMargins();

        marginId++;
      }

      function addCavityShaving() {
        var shavingsPresent = []
        $("#shavings").find("select[id^=r-cs-location]").find(":selected").each(function(i) {
          shavingsPresent.push($(this).val())
        });

        var el = $("#shavings-template").clone().removeClass("d-none").addClass("cs-section").attr('id','shaving-'+marginId).appendTo("#shavings");
        var els = el.find("input[id]").each (function(i) {
          $(this).attr('id',$(this).attr('id') + "-" + shavingId);
        })

        var els = el.find("select[id]").each (function(i) {
          $(this).attr('id',$(this).attr('id') + "-" + shavingId);
        })

        el.find("select[id^=r-cs-location]").find("option").each(function(i){
          if (!shavingsPresent.includes($(this).val())) {
            $(this).prop("selected",true)
            return false;
          }
        })

        attachEvents();

        updateCavityShavings();

        shavingId++;
      }

      function addReceptors() {
        var el = $("#receptors-template").clone().removeClass("d-none").addClass("receptors-section").attr('id','receptors-'+receptorId).appendTo("#receptors");
        var els = el.find("input[id]").each (function(i) {
          $(this).attr('id',$(this).attr('id') + "-" + receptorId);
        })
        var els = el.find("label[for]").each (function(i) {
          $(this).attr('for',$(this).attr('for') + "-" + receptorId);
        })
        var els = el.find("select[id]").each (function(i) {
          $(this).attr('id',$(this).attr('id') + "-" + receptorId);
        })

        attachEvents();

        //updateShavings();

        receptorId++;
      }

      function changedShaving(el) {
        if ($(el).val() == "involved") {
          $(el).siblings("input[id^=r-cs-distance]").removeClass("d-none")
          $(el).siblings("div div[id^=r-cs-distance-label]").removeClass("d-none")
        }
        else {
          $(el).siblings("input[id^=r-cs-distance]").addClass("d-none")
          $(el).siblings("div div[id^=r-cs-distance-label]").addClass("d-none")
        }
      }

      function changedMargin(el) {
        if ($(el).val() == "uninvolved") {
          $(el).siblings("input[id^=r-margin-distance]").removeClass("d-none")
          $(el).siblings("div[id^=r-margin-distance-label]").removeClass("d-none")
        }
        else {
          $(el).siblings("input[id^=r-margin-distance]").addClass("d-none")
          $(el).siblings("div[id^=r-margin-distance-label]").addClass("d-none")
        }
      }

      function removeMargin(el) {
          el.closest("div.margin-section").remove();

          if ($("div.margin-section").length > 1) {
            $("#nearest-margin-label").text("Nearest Radial Margins")
          }
          else {
            $("#nearest-margin-label").text("Nearest Radial Margin")
          }

          updateMargins()
      }

      function removeShaving(el) {
          el.closest("div.cs-section").remove();
          updateCavityShavings();
      }

      function removeReceptors(el) {
          el.closest("div.receptors-section").remove();
      }

      function updateMargins() {
        if ($("div.margin-section").length > 1) {
          $("#nearest-margin-label").text("Nearest Margins")
          $("button.margin-remove-button").each(function(i) {
            $(this).removeClass("d-none");
          })
        }
        else {
          $("#nearest-margin-label").text("Nearest Margin")
          $("button.margin-remove-button").each(function(i) {
            $(this).addClass("d-none");
          })
        }
      }

      function updateCavityShavings() {
        if ($("div.cs-section").length > 1) {
          $("#cavity-shavings-label").text("Cavity Shavings")
          $("#cavity-shavings-label").removeClass("d-none")
        }
        else if  ($("div.cs-section").length == 1){
          $("#cavity-shavings-label").text("Cavity Shaving")
          $("#cavity-shavings-label").removeClass("d-none")
        } else {
          $("#cavity-shavings-label").addClass("d-none")
        }
      }

      function updateTumourCount() {
        if ($("div.tumour-section > h2.tumour-heading").length > 1) {
          $(".tumour-heading").each(function(i){
            $(this).text("Tumour " + (i+1))
            $("div.tumour-close-button").each(function(i) {
              $(this).removeClass("d-none");
            })
          })
        }
        else {
          $(".tumour-heading").each(function(i){
            $(this).text("Tumour");
          })
          $("div.tumour-close-button").each(function(i) {
            $(this).addClass("d-none");
          })
        }
      }

      function copyToClipboard() {
        var str = document.getElementById('reportText').innerHTML;

        function listener(e) {
          e.clipboardData.setData("text/html", str);
          e.clipboardData.setData("text/plain", str);
          e.preventDefault();
        }
        document.addEventListener("copy", listener);
        document.execCommand("copy");
        document.removeEventListener("copy", listener);
      };

      function attachEvents() {
        $("input").off().on("change", function() {
          updateReport();
        });
        $("select").off().on("change",function() {
          updateReport();
        });

        errorChecks();
      }

      function errorChecks() {
        //checks
        $(".tumour-section").each(function(i) {
          if (isNaN(parseInt($(this).find("input[id^=r-its]").val()))) {
            $(this).find("input[id^=r-its]").addClass("bg-danger text-light")
          }
          else {
            $(this).find("input[id^=r-its]").removeClass("bg-danger text-light")
          }
        })

        sectionsToCheck = [[".tumour-section","r-wts"],[".tumour-section","r-its"],[".receptors-section","r-er-p"],[".receptors-section","r-er-i"],[".receptors-section","r-pr-p"],[".receptors-section","r-pr-i"],[".margin-section","r-margin-distance"],[".cs-section","r-cs-distance"],["body","r-total-nodes"],["body","r-macrometastases"],["body","r-micrometastases"],["body","r-itc"]]
        sectionsToCheck.forEach(function(section){
          $(section[0]).each(function(i) {
            if (isNaN(parseInt($(this).find("input[id^="+section[1]+"]").val()))) {
              $(this).find("input[id^="+section[1]+"]").addClass("bg-danger text-light")
            }
            else {
              $(this).find("input[id^="+section[1]+"]").removeClass("bg-danger text-light")
            }
          })
        })
        sectionsToCheck = [[".receptors-section","r-receptors-labno"]]
        sectionsToCheck.forEach(function(section){
          $(section[0]).each(function(i) {
            if ($(this).find("input[id^="+section[1]+"]").val().length == 0) {
              $(this).find("input[id^="+section[1]+"]").addClass("bg-danger text-light")
            }
            else {
              $(this).find("input[id^="+section[1]+"]").removeClass("bg-danger text-light")
            }
          })
        })

        sectionsToCheck = [[".tumour-section","r-tumour-description"],[".receptors-section","r-receptors-desc"]]
        sectionsToCheck.forEach(function(section){
          if ($(section[0]).length > 1){
            $(section[0]).each(function(i) {
              if (isNaN(parseInt($(this).find("input[id^="+section[1]+"]").val()))) {
                $(this).find("input[id^="+section[1]+"]").addClass("bg-warning text-dark")
              }
              else {
                $(this).find("input[id^="+section[1]+"]").removeClass("bg-warning text-dark")
              }
            })
          }
        })
      }

      function updateReport() {
        //attach events
        attachEvents();

        errorChecks();

        //alterations
        $("select[id^=r-margin-involved]").each(function (i) {
          if ($(this).val() == "uninvolved") {
            $(this).addClass("col-sm-2")
            $(this).removeClass("col-sm-6")
          }
          else {
            $(this).removeClass("col-sm-2")
            $(this).addClass("col-sm-6")
          }
        });

        $("select[id^=r-cs-involved]").each(function (i) {
          if ($(this).val() == "involved") {
            $(this).addClass("col-sm-5")
            $(this).removeClass("col-sm-7")
          }
          else {
            $(this).removeClass("col-sm-5")
            $(this).addClass("col-sm-7")
          }
        });

        if ($("#r-neoadjuvant-given").val() == "no") {
          $("#r-neoadjuvant-breast-response").parent().parent().addClass("d-none")
          $("#r-neoadjuvant-node-response").parent().parent().addClass("d-none")
        }
        else {
          $("#r-neoadjuvant-breast-response").parent().parent().removeClass("d-none")
          $("#r-neoadjuvant-node-response").parent().parent().removeClass("d-none")
        }

        $("#reportText").empty();
        $("#reportText").append("<div class=\"col-sm-12\" style=\"font-weight:bold; text-decoration:underline; text-transform:uppercase;\">Breast Cancer Proforma</div>");
        $("#report-fields div.tumour-section").each(function(i) {
          if (($("div.tumour-section").length > 1) || ($(this).find("[id^=r-tumour-desc]").val().length > 0)) {
            heading = $(this).find("[id^=r-tumour-desc]").val()
            if (heading.length == 0) {
              heading =  $(this).find("h2").text()
            }
            $("#reportText").append("<div class=\"col-sm-12\">&nbsp;</div>");
            $("#reportText").append("<div style=\"font-weight: bold;\">"+heading+"</div>")
          }

          if($(this).find("input[type=checkbox][id^=r-other-tumour]").is(":checked"))
          {
            $(this).find("input[id^=r-other-tumour-text]").removeClass("d-none");
          }
          else
          {
            $(this).find("input[id^=r-other-tumour-text]").addClass("d-none");
          }

          tumourTypes = $(this).find("input[type=checkbox]:checked")
          var tumourTypesText = ""
          if (tumourTypes.length > 1) {
            var tumourTypesText = "Mixed ("
            tumourTypes.each(function(i) {
              if (i>0 && i < tumourTypes.length-1){
                tumourTypesText = tumourTypesText + ", "
              }
              else if (i == tumourTypes.length-1){
                tumourTypesText = tumourTypesText + " and "
              }
              var appendText = ($(this).val() == "other") ? $(this).parent().siblings("div.container-other-tumour-text").find("input[id^=r-other-tumour-text]").val() : $(this).siblings("label").data("report-text") ;
              tumourTypesText = tumourTypesText + appendText;
            })
            tumourTypesText = tumourTypesText + ")";
          }
          else {
            tumourTypesText = ($(tumourTypes.get(0)).val() == "other") ? $(tumourTypes.get(0)).parent().siblings("div.container-other-tumour-text").find("input[id^=r-other-tumour-text]").val() : $(tumourTypes.get(0)).siblings("label").data("report-text")
          }
          tumourGradeT = parseInt($(this).find("select[id^=tg-tubules-]").val())
          tumourGradeP = parseInt($(this).find("select[id^=tg-pleomorphism-]").val())
          tumourGradeM = parseInt($(this).find("select[id^=tg-mitoses-]").val())
          tumourGradeSum = tumourGradeT + tumourGradeP + tumourGradeM;
          var tumourGrade = 1;
          if (tumourGradeSum == 6 || tumourGradeSum == 7) {
            tumourGrade = 2;
          } else if (tumourGradeSum >= 8){
            tumourGrade = 3;
          }

          $("#reportText").append("<div class=\"col-sm-12\">- Tumour type: "+ tumourTypesText +"</div>");
          $("#reportText").append("<div class=\"col-sm-12\">- Tumour grade: "+ tumourGrade +" (T"+tumourGradeT+", P" + tumourGradeP + ", M" + tumourGradeM +")</div>");
          $("#reportText").append("<div class=\"col-sm-12\">- Invasive tumour size: "+ $(this).find("input[id^=r-its]").val() +"mm </div>");
          $("#reportText").append("<div class=\"col-sm-12\">- Ductal carcinoma in-situ: "+ $(this).find("select[id^=r-dcis]").find(":selected").text() +"</div>");
          if ($(this).find("select[id^=r-plcis]").find(":selected").val()==1) {
            $("#reportText").append("<div class=\"col-sm-12\">- Pleomophic lobular carcinoma in-situ: "+ $(this).find("select[id^=r-plcis]").find(":selected").text() +"</div>");
          }
          $("#reportText").append("<div class=\"col-sm-12\">- Whole tumour size: "+ $(this).find("input[id^=r-wts]").val() +"mm </div>");
          $("#reportText").append("<div class=\"col-sm-12\">- Lymphovascular space invasion: "+ $(this).find("select[id^=r-lvi]").find(":selected").text() +"</div>");
        })
        if ($("#r-background-breast").val().length) {
          $("#reportText").append("<div class=\"col-sm-12\">&nbsp;</div>");
          $("#reportText").append("<div class=\"col-sm-12\" style=\"font-weight:bold; text-decoration:underline;\">Background breast</div>");
          $("#reportText").append("<div class=\"col-sm-12\">"+ $("#r-background-breast").val() +"</div>");
        }

        $("#reportText").append("<div class=\"col-sm-12\">&nbsp;</div>");
        $("#reportText").append("<div class=\"col-sm-12\" style=\"font-weight:bold; text-decoration:underline;\">Margins</div>");

        $(".margin-section").each(function(i) {
          var distance ="";
          if ($(this).find("select[id^=r-margin-involved]").val() != "involved") {
            measurement = parseInt($(this).find("input[id^=r-margin-distance]").val())
            measurement = measurement == 0 ? "less than 1mm" : measurement+"mm";
            distance =  measurement + " from margin"
          }
          else {
            distance = $(this).find("select[id^=r-margin-involved] > option:selected").data("report-text")
          }
          $("#reportText").append("<div class=\"col-sm-12\"> - "+$(this).find("select[id^=r-margin-location]").find(":selected").text()+" margin: " + distance +  "</div>")
        })

        if ($(".cs-section").length > 0) {
          $("#reportText").append("<div class=\"col-sm-12\">&nbsp;</div>");
          $("#reportText").append("<div class=\"col-sm-12\" style=\"font-weight:bold; text-decoration:underline;\">Cavity Shavings</div>");

          $(".cs-section").each(function(i) {
            var distance ="";
            if ($(this).find("select[id^=r-cs-involved]").val() == "involved") {
              measurement = parseInt($(this).find("input[id^=r-cs-distance]").val())
              if (!isNaN(measurement)) {
                distance = " - " + parseInt($(this).find("input[id^=r-cs-distance]").val()) + "mm from margin."
              }
            }
            $("#reportText").append("<div class=\"col-sm-12\"> - "+$(this).find("select[id^=r-cs-location]").find(":selected").text()+" cavity shaving: " + $(this).find("select[id^=r-cs-involved]").find(":selected").data("report-text") + distance + "</div>")
          })
        }
        $("#reportText").append("<div class=\"col-sm-12\">&nbsp;</div>");
        lymphNodesType = $("#r-node-biopsy-type").find(":selected").text()
        lymphNodesType = lymphNodesType == "Other" ? "" : " - " + lymphNodesType
        $("#reportText").append("<div class=\"col-sm-12\" style=\"font-weight:bold; text-decoration:underline;\">Lymph Nodes"+lymphNodesType+"</div>");
        if ($("#r-node-biopsy-type").val() != "none") {
          $("#reportText").append("<div class=\"col-sm-12\"> - Total lymph nodes: " + parseInt($("#r-total-nodes").val()) + "</div>")
          $("#reportText").append("<div class=\"col-sm-12\"> - Nodes with macrometastases: " + parseInt($("#r-macrometastases").val()) + "</div>")
          $("#reportText").append("<div class=\"col-sm-12\"> - Nodes with micrometastases: " + parseInt($("#r-micrometastases").val()) + "</div>")
          $("#reportText").append("<div class=\"col-sm-12\"> - Nodes with isolated tumour cells: " + parseInt($("#r-itc").val()) + "</div>")
        }

        if ($("#r-neoadjuvant-given").val() == "yes") {
          $("#reportText").append("<div class=\"col-sm-12\">&nbsp;</div>")
          $("#reportText").append("<div class=\"col-sm-12\" style=\"font-weight:bold; text-decoration:underline;\">Response to Neoadjuvant Therapy</div>");
          $("#reportText").append("<div class=\"col-sm-12\">Breast disease response: "+ $("#r-neoadjuvant-breast-response > :selected").text() +" ("+$("#r-neoadjuvant-breast-response > :selected").val()+")</div>");
          $("#reportText").append("<div class=\"col-sm-12\">Lymph node disease response: "+ $("#r-neoadjuvant-node-response > :selected").text() +" ("+$("#r-neoadjuvant-node-response > :selected").val()+")</div>");
        }

        if ($("#r-comments").val().length) {
          $("#reportText").append("<div class=\"col-sm-12\">&nbsp;</div>")
          $("#reportText").append("<div class=\"col-sm-12\" style=\"font-weight:bold; text-decoration:underline;\">Comments</div>");
          $("#reportText").append("<div class=\"col-sm-12\"> "+ $("#r-comments").val() +"</div>");
        }

        $("#reportText").append("<div class=\"col-sm-12\">&nbsp;</div>");
        $("#reportText").append("<div class=\"col-sm-12\" style=\"font-weight:bold; text-decoration: underline;\">Molecular Testing</div>");
        $("#reportText").append("<div class=\"col-sm-12\">- Best block for testing: "+$("#dsGeneticsBestTumour1").val() +" (Tumour content: " + parseInt($("#dsGeneticsTumourPercentage1").val()) +"%)");
        $("#reportText").append("<div class=\"col-sm-12\">- Best block for normal control: "+$("#dsGeneticsNormal").val() +"</div>");

        $("#reportText").append("<div class=\"col-sm-12\">&nbsp;</div>");
        $("#reportText").append("<div class=\"col-sm-12\" style=\"font-weight:bold; text-decoration:underline;\">Summary</div>");
        var summaryLVI = false;
        var largestTumour = 0;
        $("#report-fields div.tumour-section").each(function(i) {
          tumourTypes = $(this).find("input[type=checkbox]:checked")
          var tumourTypesText = ""
          if (tumourTypes.length > 1) {
            var tumourTypesText = "Mixed ("
            tumourTypes.each(function(i) {
              if (i>0 && i < tumourTypes.length-1){
                tumourTypesText = tumourTypesText + ", "
              }
              else if (i == tumourTypes.length-1){
                tumourTypesText = tumourTypesText + " and "
              }
              tumourTypesText = tumourTypesText + $(this).siblings("label").data("report-text");
            })
            tumourTypesText = tumourTypesText + ")";
          }
          else {
            tumourTypesText = $(tumourTypes.get(0)).siblings("label").data("report-text")
          }
          tumourGradeT = parseInt($(this).find("select[id^=tg-tubules-]").val())
          tumourGradeP = parseInt($(this).find("select[id^=tg-pleomorphism-]").val())
          tumourGradeM = parseInt($(this).find("select[id^=tg-mitoses-]").val())
          tumourGradeSum = tumourGradeT + tumourGradeP + tumourGradeM;
          var tumourGrade = 1;
          if (tumourGradeSum == 6 || tumourGradeSum == 7) {
            tumourGrade = 2;
          } else if (tumourGradeSum >= 8){
            tumourGrade = 3;
          }
          var tumourDesc = ""
          if ($(this).find("input[id^=r-tumour-description]").val().trim().length > 0) {
            tumourDesc = $(this).find("input[id^=r-tumour-description]").val().trim() + ": ";
          }
          if ($("div.tumour-section").length > 1 && tumourDesc.trim().length == 0) {
            tumourDesc = $(this).find("h2").text() + ": ";
          }

          if (!summaryLVI) {
            summaryLVI = $(this).find("select[id^=r-lvi]").val() == "true"
          }
          var its = parseInt($(this).find("input[id^=r-its]").val())
          if (its > largestTumour) {
            largestTumour = its;
          }
          $("#reportText").append("<div class=\"col-sm-12\">- " + tumourDesc + tumourTypesText +", Grade "+tumourGrade+" (ITS: " + its + "mm, TNM8 "+getTStage(its)+")</div>");
        })
        $("#reportText").append("<div class=\"col-sm-12\">&nbsp;</div>");

        if (summaryLVI){
          $("#reportText").append("<div class=\"col-sm-12\">- Lymphovascular invasion present</div>")
        } else {
          $("#reportText").append("<div class=\"col-sm-12\">- Lymphovascular invasion not identified</div>")
        }
        totalLNInvolved = (parseInt($("#r-macrometastases").val()) + parseInt($("#r-micrometastases").val()))
        addendumLN = ""
        if (totalLNInvolved == 1 &&   parseInt($("#r-macrometastases").val()) == 1) {
          addendumLN = " (macrometastasis) "
        } else if (totalLNInvolved == 1 &&   parseInt($("#r-micrometastases").val()) == 1) {
          addendumLN = " (micrometastasis) "
        }

        $("#reportText").append("<div class=\"col-sm-12\">- Lymph Nodes: " + totalLNInvolved + "/" + parseInt($("#r-total-nodes").val()) + addendumLN +"</div>");

        $("#reportText").append("<div class=\"col-sm-12\">- TNM8 "+ getTStage(largestTumour) +" "+ getNStage()+"</div>")

        $("#reportText").append("<div class=\"col-sm-12\">&nbsp;</div>");
        $(".receptors-section").each(function(i) {
          var receptorsDesc = ""
          if ($(this).find("input[id^=r-receptors-desc]").val().trim().length > 0) {
            receptorsDesc = $(this).find("input[id^=r-receptors-desc]").val().trim() + ": ";
          }
          var erp = parseInt($(this).find("input[id^=r-er-p]").val())
          var eri = parseInt($(this).find("input[id^=r-er-i]").val())
          var prp = parseInt($(this).find("input[id^=r-pr-p]").val())
          var pri = parseInt($(this).find("input[id^=r-pr-i]").val())
          $("#reportText").append("<div class=\"col-sm-12\"> - " + receptorsDesc + "ER " + (erp+eri) + " (P"+erp+" I"+eri+"), PR " + (prp+pri) + " (P"+prp+" I"+pri+"), Her2 "+$(this).find("select[id^=r-her2]").find(":selected").text()+ " (Please see " +$(this).find("input[id^=r-receptors-labno]").val()+ ")")
          $("#reportText").append("<div class=\"col-sm-12\">&nbsp;</div>");
          $("#reportText").append("<div class=\"col-sm-12\">&nbsp;</div>");
          $("#reportText").append("<div class=\"col-sm-12\" style=\"font-style:italic; font-size:smaller;\">Breast Carcinoma Proforma v1.0beta - BETA VERSION - Check carefully and use with caution.</div>");
        })
      }

      function getTStage(tumourSize) {
        var tStage ="pT1mi";
        if (tumourSize > 1) {
          tStage = "pT1a"
        }
        if (tumourSize > 5) {
          tStage = "pT1b"
        }
        if (tumourSize > 10) {
          tStage = "pT1c"
        }
        if (tumourSize > 20) {
          tStage = "pT2"
        }
        if (tumourSize > 50) {
          tStage = "pT3"
        }
        return tStage;
      }

      function getNStage() {
        var totalNodes = parseInt($("#r-total-nodes").val())
        var macroMets = parseInt($("#r-macrometastases").val())
        var microMets = parseInt($("#r-micrometastases").val())
        var itcMets = parseInt($("#r-itc").val())


        if (isNaN(totalNodes)) {
          return false
        }
        if (totalNodes == 0) {
          return "pNx"
        }
        if (macroMets > 0 && macroMets + microMets >=4 && macroMets + microMets <=9) {
          return "pN2a";
        }

        if (macroMets + microMets >=10) {
          return "pN3a";
        }

        if (macroMets > 0 && macroMets + microMets >=1 && macroMets + microMets <=3) {
          return "pN1a";
        }

        if (macroMets == 0 && microMets > 0) {
          return "pN1mi"
        }

        if (macroMets == 0 && microMets == 0 && itcMets > 0) {
          return "pN0i+"
        }

        if (macroMets == 0 && microMets == 0 && itcMets == 0) {
          return "pN0"
        }

        return "pN(ERROR)"

      }
    </script>
  </body>
</html>
